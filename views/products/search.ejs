<%- include('../partials/header') %>

<h2 class="search-title">Resultados para "<%= query %>"</h2>

<% if (grouped.length === 0) { %>
  <div class="no-results">
    <p>No encontramos productos para "<%= query %>".</p>
    <a href="/">Volver al inicio</a>
  </div>
<% } else { %>
  <div class="results-grid">
    <% grouped.forEach(group => { %>
      <div class="product-group">
        <h3 class="product-group-title"><%= group[0].name %></h3>
        <div class="stores-comparison">
          <% group.sort((a, b) => a.price - b.price).forEach((product, index) => { %>
            <div class="store-card <%= index === 0 ? 'best-price' : '' %>">
              <% if (index === 0) { %><span class="badge">Mejor Precio</span><% } %>
              <% if (product.image) { %>
                <img src="<%= product.image %>" alt="<%= product.name %>" />
              <% } %>
              <div class="store-info">
                <span class="store-name"><%= product.Store.name %></span>
                <span class="price">RD$ <%= parseFloat(product.price).toFixed(2) %></span>
              </div>
              <div class="store-actions">
                <a href="<%= product.url %>" target="_blank" class="btn-ver">Ver en tienda</a>
                <% if (typeof session !== 'undefined' && session.userId) { %>
                  <button class="btn-alerta" onclick="openAlertModal(<%= product.id %>, '<%= product.name.replace(/'/g, "\\'") %>', <%= product.price %>)">
                    ðŸ”” Crear alerta
                  </button>
                <% } else { %>
                  <a href="/auth/login" class="btn-alerta">ðŸ”” Crear alerta</a>
                <% } %>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    <% }) %>
  </div>
<% } %>

<!-- Modal para crear alerta -->
<div id="alertModal" class="modal hidden">
  <div class="modal-content">
    <h3>Crear Alerta de Precio</h3>
    <p id="modal-product-name"></p>
    <p>Precio actual: <strong id="modal-current-price"></strong></p>
    <form action="/alerts" method="POST">
      <input type="hidden" name="productId" id="modal-product-id"/>
      <label>AvÃ­same cuando el precio baje de:</label>
      <input type="number" name="targetPrice" step="0.01" min="1" required />
      <button type="submit">Guardar Alerta</button>
      <button type="button" onclick="closeAlertModal()">Cancelar</button>
    </form>
  </div>
</div>

<%- include('../partials/footer') %>
